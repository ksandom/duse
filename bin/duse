#!/bin/bash
# duse - A directory shim manager for managing an source and a read-only cache of data.

# Make sure we have $HOME set so that we can make assumptions based on it, and the unit tests can override it.
if [ "$HOME" == '' ]; then
  HOME=~
fi
duseHome="$HOME/.config/duse"
contextHome="$duseHome/contexts"


# ./bin/duse --addContext shoots "A collection of photo/video shoots."
function addContext # 00: Add a new context that will have sources and cache associated with it. Usage: addContext shortName "Description."
{
  contextName="$1"
  contextDescription="$2"
  contextPath="$contextHome/$contextName"
  
  if [ "$1" == '' ]; then
    echo "Need a name and description." >&2
    return 1
  fi
  
  if [ -e "$contextPath" ]; then
    echo "Context $contextName already exists." >&2
    return 1
  fi
  
  mkdir -pv "$contextPath"
  echo "$contextDescription" | tee "$contextPath/description"
}

function private_listContextThing
{
  contextName="$1"
  thingName="$2"
  thingDirName="$3"
  thingPath="$contextHome/$context/$thingDirName"
  
  if [ -e "$thingPath" ]; then
    echo "  $thingName:"
    if [ "$(ls -1 "$thingPath" | wc -l)" -lt 1 ]; then
      echo "    None anymore."
      rmdir "$thingPath"
    else
      for thingItem in "$thingPath"/*; do
        echo "    $(basename "$thingItem"): $(cat $thingItem)"
      done
    fi
  else
    echo "  $thingName: None yet."
  fi
}

function private_showContext
{
  context="$1"
  echo "$context: $(cat "$contextHome/$context/description")"
  
  private_listContextThing "$context" "Sources" "sources"
  private_listContextThing "$context" "Cache" "cache"
  private_listContextThing "$context" "Workspaces" "workspaces"
}

function listContexts # List contexts and their associated data.
{
  if [ -e "$contextHome" ]; then
    while read context; do
      private_showContext "$context"
    done < <(ls "$contextHome")
  else
    echo "No contexts yet." >&2
    exit 1
  fi
}

function private_contextExists
{
  local contextName="$1"
  local contextPath="$contextHome/$contextName"
  
  if [ ! -e "$contextPath" ]; then
    return 1
  else
    return 0
  fi
}

function deleteContext # Delete a context. --deleteContext contextName . Note that this will delete all duse references to the context, but will not check any cases where it might be used. If they exist, they will be orphaned and unmanaged. The context can be manually re-created, and the references will be usable again.
{
  contextName="$1"
  contextPath="$contextHome/$contextName"
  
  if ! private_contextExists "$contextName"; then
    echo "Context \"$contextName\" not found." >&2
    return 1
  fi
  
  rm -Rfv "$contextPath"
}



function private_sourceName # Gives us a unique name based on a file path.
{
  local sourcePath="$1"
  
  echo "$sourcePath" | sed "s#\(/\| \)#_#g"
}

function private_sourceExists
{
  local contextName="$1"
  local sourceVanillaPath="$2"
  local sourcePath="$(private_sourcePath "$contextName" "$sourceVanillaPath")"
  
  if ! private_contextExists "$contextName"; then
    echo "Context \"$contextName\" not found." >&2
    return 1
  fi
  
  if [ ! -e "$sourcePath" ]; then
    return 1
  else
    return 0
  fi
}

function private_sourcePath
{
  local contextName="$1"
  local sourceVanillaPath="$2"
  local sourcesPath="$contextHome/$contextName/sources"
  local sourceName="$(private_sourceName "$sourceVanillaPath")"
  
  echo "$sourcesPath/$sourceName"
}

function addSource # 01: Add a source to a context. --addsource contextName sourcePath
{
  contextName="$1"
  contextPath="$contextHome/$contextName"
  sourcesPath="$contextHome/$contextName/sources"
  sourceVanillaPath="$2"
  fullSourcePath="$(realpath "$2")"
  sourcePath="$(private_sourcePath "$contextName" "$sourceVanillaPath")"
  
  if ! private_contextExists "$contextName"; then
    echo "Context \"$contextName\" not found." >&2
    return 1
  fi
  
  if private_sourceExists "$contextName" "$sourceVanillaPath";  then
    echo "Source \"$sourceVanillaPath\" already exists within context \"$contextName\"." >&2
    return 1
  fi
  
  mkdir -p "$sourcesPath"
  echo "$fullSourcePath" > "$sourcePath"
}

function deleteSource # Delete a source from a context. --deleteSource contextName sourcePath
{
  contextName="$1"
  contextPath="$contextHome/$contextName"
  sourcesPath="$contextHome/$contextName/sources"
  sourceVanillaPath="$2"
  fullSourcePath="$(realpath "$2")"
  sourcePath="$(private_sourcePath "$contextName" "$sourceVanillaPath")"
  
  if ! private_contextExists "$contextName"; then
    echo "Context \"$contextName\" not found." >&2
    return 1
  fi
  
  if ! private_sourceExists "$contextName" "$sourceVanillaPath";  then
    echo "Source \"$sourceVanillaPath\" does not exist within context \"$contextName\"." >&2
    return 1
  fi
  
  rm "$sourcePath"
}

function setCache # 02: Set the location where you want cache to be stored. --setCache contextName /path/to/cache/location
{
  contextName="$1"
  contextPath="$contextHome/$contextName"
  cachePath="$(realpath "$2")"
  
  if ! private_contextExists "$contextName"; then
    echo "Context \"$contextName\" not found." >&2
    return 1
  fi
  
  if [ ! -e "$cachePath" ]; then
    echo "The path \"$cachePath\" doesn't appear to exist." >&2
    return 1
  fi
  
  mkdir -p "$contextPath/cache"
  echo "$cachePath" > "$contextPath/cache/location"
}

function private_registerWorkspace
{
  local contextName="$1"
  local contextPath="$contextHome/$contextName"
  local workspaceName="$2"
  local workspacePath="`pwd`/$workspaceName"
  local workspaceNiceName=$(private_sourceName "$workspacePath")
  local action="${3:-register}"
  
  case "$action" in
    "register")
      mkdir -p "$contextPath/workspaces"
      echo "$workspacePath" > "$contextPath/workspaces/$workspaceNiceName"
    ;;
    "unregister")
      rm "$contextPath/workspaces/$workspaceNiceName"
      if [ "$(ls "$contextPath/workspaces" | wc -l)" -lt 1 ]; then
        rmdir "$contextPath/workspaces"
      fi
    ;;
  esac
}

function createWorkspace # 03: Create a workspace that will use the context that you have created. --createWorkspace contextName workspaceName
{
  contextName="$1"
  contextPath="$contextHome/$contextName"
  workspaceName="$2"
  
  mkdir -p "$workspaceName/.duse"
  echo "$contextName" > "$workspaceName/.duse/context"
  
  private_registerWorkspace "$contextName" "$workspaceName"
}

function deleteWorkspace # Delete a workspace. --createWorkspace workspaceNameOrPath
{
  workspaceNameOrPath="$1"
  if [ ! -e "$workspaceNameOrPath/.duse" ]; then
    echo "Could not find a valid workspace at \"$workspaceNameOrPath\"." >&2
    return 1
  fi
  
  contextName="$(cat "$workspaceNameOrPath/.duse/context")"
  contextPath="$contextHome/$contextName"
  
  # TODO uncache everything in this workspace.
  
  private_registerWorkspace "$contextName" "$workspaceNameOrPath" 'unregister'
  rm -Rvf "$workspaceNameOrPath"
}

function info # Show basic information about the current workspace.
{
  if [ ! -e '.duse/context' ]; then
    echo "This does not appear to be a workspace." >&2
    return 1
  fi
  
  private_showContext "$(cat '.duse/context')"
}



################################################################################

function help # Show this help.
{
  echo "Valid commands are"
  echo
  grep "^function" "$0" | grep -v '\(private_\)' | sed 's/^function *//g; s/ # /\^/g; s/^/--/g' | column -t -s '^'
}

##### Stuff for handling parameters.
function private_showCommands
{
  grep "^function" "$0" | awk '{ print $2 }' | grep -v '\(private_\)'
}

function private_isValidCommand
{
  private_showCommands | grep -q "^$1$"
  return "$?"
}

function private_getCommandFromArg
{
  if [ "${1::2}" == '--' ]; then
    command="${1:2}"
    if private_isValidCommand "$command"; then
      echo "$command"
    else
      return 1
    fi
  else
    return 1
  fi
}

if [ "$1" == '' ]; then
  help
else
  if command="$(private_getCommandFromArg "$1")"; then
    shift
    "$command" "$@"
    exit "$?"
  else
    echo "$0: Command not found." >&2
  fi
fi
