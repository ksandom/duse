#!/bin/bash
# duse - A directory shim manager for managing an source and a read-only cache of data.

# Make sure we have $HOME set so that we can make assumptions based on it, and the unit tests can override it.
if [ "$HOME" == '' ]; then
  HOME=~
fi
duseHome="$HOME/.config/duse"
contextHome="$duseHome/contexts"


# ./bin/duse --addContext shoots "A collection of photo/video shoots."
function addContext # 00: Add a new context that will have sources and cache associated with it. Usage: addContext shortName "Description."
{
  contextName="$1"
  contextDescription="$2"
  contextPath="$contextHome/$contextName"
  
  if [ "$1" == '' ]; then
    echo "Need a name and description." >&2
    return 1
  fi
  
  if [ -e "$contextPath" ]; then
    echo "Context $contextName already exists." >&2
    return 1
  fi
  
  mkdir -pv "$contextPath"
  echo "$contextDescription" | tee "$contextPath/description"
}

function listContexts # List contexts and their associated data.
{
  if [ ! -d "$contextHome" ]; then
    echo "There don't appear to be any contexts yet." >&2
    return 1
  fi
  
  while read context; do
    private_showContext "$context"
  done < <(ls "$contextHome")
}

function deleteContext # Delete a context. --deleteContext contextName . Note that this will delete all duse references to the context, but will not check any cases where it might be used. If they exist, they will be orphaned and unmanaged. The context can be manually re-created, and the references will be usable again.
{
  contextName="$1"
  contextPath="$contextHome/$contextName"
  
  if [ ! -e "$contextPath" ]; then
    echo "Context \"$contextName\" not found." >&2
    return 1
  fi
  
  rm -Rfv "$contextPath"
}


function help # Show this help.
{
  echo "Valid commands are"
  grep "^function" "$0" | grep -v '\(private_\)' | sed 's/^function *//g; s/ # /    /g; s/^/--/g'
}

function private_showContext
{
  context="$1"
  echo "$context: $(cat "$contextHome/$context/description")"
}

#function removeContext

##### Stuff for handling parameters.
function private_showCommands
{
  grep "^function" "$0" | awk '{ print $2 }' | grep -v '\(private_\)'
}

function private_isValidCommand
{
  private_showCommands | grep -q "^$1$"
  return "$?"
}

function private_getCommandFromArg
{
  if [ "${1::2}" == '--' ]; then
    echo "${1:2}"
  else
    return 1
  fi
}

if [ "$1" == '' ]; then
  help
else
  if command="$(private_getCommandFromArg "$1")"; then
    shift
    "$command" "$@"
  else
    echo "$0: Command not found." >&2
  fi
fi
