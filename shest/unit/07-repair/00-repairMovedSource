#!/bin/bash
# Test --repair with user-created problems.

. "$SHEST_SCRIPT" "--doNothing"

projectHome="$HOME/projects/example"


mv source/source2/004 source/source1 ## Test this.
expect_exitCode 0 "mv 1"

cd "$projectHome/shoots1"

$HOME/bin/duse --repair ## Test this.
expect_exitCode 2 "Should warn (but not fail) that something was repaired."

cd ..
$HOME/bin/duse --repair ## Test this.
expect_exitCode 2 "Same as above, but globally."

$HOME/bin/duse --repair ## Test this.
expect_exitCode 0 "There should be nothing left to repair."

mv shoots2 shootsb ## Test this.
expect_exitCode 0 "mv 2"

$HOME/bin/duse --repair ## Test this.
expect_exitCode 2 "Moved workspace."

$HOME/bin/duse --repair ## Test this.
expect_exitCode 0 "There should be nothing left to repair."

rm -Rf source/source2/005 ## Test this.
expect_exitCode 0 "Remove at the source while it is still in use."

$HOME/bin/duse --repair ## Test this.
expect_exitCode 2 "Removed from source."

$HOME/bin/duse --repair ## Test this.
expect_exitCode 0 "There should be nothing left to repair."

# Here is a list of expect_.* helper functions provided via /usr/bin/shest --listExpects :
#
# expect_exitCode expectedCode [message] [resultOverride]
# expect_not_exitCode unexpectedCode [message] [resultOverride]
# expect_value actualValue expectedValue [message] [resultOverride] [contextOverride]
# expect_not_value actualValue unexpectedValue [message] [resultOverride] [contextOverride]
# expect_exists fileOrDirectoryPath [message] [resultOverride]
# expect_not_exists fileOrDirectoryPath [message] [resultOverride]
# expect_fileContains fileOrDirectoryPath regexOrString [message] [resultOverride]
# expect_not_fileContains fileOrDirectoryPath regexOrString [message] [resultOverride]
# expect_resultContains regexOrString [message] [resultOverride]
# expect_not_resultContains regexOrString [message] [resultOverride]
# expect_errorContains regexOrString [message] [resultOverride] - Requires the "## Test this." syntax.
# expect_not_errorContains regexOrString [message] [resultOverride] - Requires the "## Test this." syntax.
# expect_resultLines numberOfLines [message] [resultOverride]
# expect_not_resultLines numberOfLines [message] [resultOverride]
# expect_errorLines numberOfLines [message] [resultOverride]
# expect_not_errorLines numberOfLines [message] [resultOverride]
# expect_condition conditionPart1 conditionPart2 conditionPart3 [message] [resultOverride] . Eg "$actualValue" -gt 2.    resolves to [ "$actualValue" "-gt" "2" ]
# expect_not_condition conditionPart1 conditionPart2 conditionPart3 [message] [resultOverride] . Eg "$actualValue" -gt 2    resolves to [ ! "$actualValue" "-gt" "2" ]


# expect_.* is preferred, but if you need more flexibility, you can also write more custom tests like this:
#
# if [ 1 -eq 1 ]; then
#   pass Yay!
# else
#   fail "1 should definitely have equalled 1."
# fi
